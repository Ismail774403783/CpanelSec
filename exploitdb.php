<?php

// Andrew De Stefano - 2012

// you will need a shodan key
$KEY = $_ENV['SHODAN_KEY'];
$SHODAN = 'http://www.shodanhq.com/api/exploitdb/search?key='.$KEY.'&q=';


function green($text) {
  return "\033[92m".$text."\033[0m";
}


// The API gives dates in international format: DD-MM-YYYY
// Let's make them a bit more familiar :P
function amurica($date) {
  $tmp = explode('.', $date);
  return $tmp[1].'.'.$tmp[0].'.'.$tmp[2];
}


// using curl becaues get_file_contents is disabled on some servers
function get_data($url) {
  $ch = curl_init();
  $timeout = 5;
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
  $data = curl_exec($ch);
  curl_close($ch);
  return $data;
}


function main($argv){

    global $SHODAN, $KEY;
    $query = implode("%20", array_slice($argv, 1));

    $data = json_decode(get_data($SHODAN.$query), true);

    if (count($data['matches']) == 0) {
      print("No results.\n");
      die();
    } 
       
    if (count($data['matches']) >= 25) {
      print("Over 25 results, try refining your search (i.e. use version numbers)\n");
      die();
    }
	
  
    foreach ($data['matches'] as $match) {
        $date = amurica($match['date']);
        print($date.' - '.green($match['description']).":\n");
        print("http://www.exploit-db.com/exploits/".$match['id']."\n\n");
    }
}


function wpscan() {
    
    // This is the "Right" way to do this, however I've disabled this for now
    // because Wordpress decided that the entire Wordpress backend 
    // (and any potential syntax errors along the way) should be loaded by
    // including only wp-config.php
    /*
    @include "wp-config.php";
    @include "wp-includes/version.php";

    $mysqli = new mysqli('localhost', DB_USER, DB_PASSWORD, DB_NAME);
    $res = $mysqli->query("SELECT option_value FROM ".$table_prefix.
                            "options WHERE option_name = 'active_plugins'");
    $row = $res->fetch_assoc();
    $plugins = unserialize($row["option_value"]);

    print("Wordpress: ".$wp_version."\nActive Plugins:\n---------------\n");
    foreach($plugins as $pkey => $pval) {
        print($pval."\n");
    }*/

    global $SHODAN, $KEY;

    @include "wp-includes/version.php";
    printf("WordPress Version: %s\n", $wp_version);

    printf("Plugins:\n--------\n");
    $dir = "wp-content/plugins/";
    $files = glob($dir."*");
    $plugins = array();
    foreach($files as $file) {
        if (is_dir($file) && $file != "wp-content/plugins/akismet") {
            $file = substr($file, 19);
            $file = str_replace('-', ' ', $file);
            printf("- %s\n", $file);

            $file = str_replace(' ', '%20', $file);
            array_push($plugins, $file);
        }
    }

    printf("\n\nWriting potential vulnerabilities to /root/Wordpress-Vulnerabilities...");
    $fh = fopen("/root/Wordpress-Vulnerabilities", "w");
    foreach ($plugins as $plugin) {
        $data = json_decode(get_data($SHODAN.$plugin), true);
        
        foreach ($data['matches'] as $match) {
            $date = amurica($match['date']);
            fwrite($fh, $date.' - '.$match['description'].":\n");
            fwrite($fh, "http://www.exploit-db.com/exploits/".$match['id']."\n\n");
        }
    }
    fclose($fh);

    printf("DONE!\n");
}


// TODO: enumerate joomla plugins, components, and modules
function joomlascan() {

}


if ($argv[1] == "-w") {
  wpscan();
} elseif ($argv[1] == "-j") {
  joomlascan();
} else {
  main($argv);
}
